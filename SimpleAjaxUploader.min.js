(function(e,t,n){var r=e.ss||{},i=/^\s+/,s=/\s+$/,o=/[xy]/g,u=/.*(\/|\\)/,a=/.*[.]/,f=/[\t\r\n]/g,l=Object.prototype.toString.call(e.HTMLElement).indexOf("Constructor")>0,c=t.createElement("input"),h;c.type="file";h="multiple"in c&&typeof File!=="undefined"&&typeof (new XMLHttpRequest).upload!=="undefined";r.obj2string=function(e,t){"use strict";var n=[];for(var i in e){if(e.hasOwnProperty(i)){var s=t?t+"["+i+"]":i,o=e[i];n.push(typeof o==="object"?r.obj2string(o,s):encodeURIComponent(s)+"="+encodeURIComponent(o))}}return n.join("&")};r.extendObj=function(e,t){"use strict";for(var n in t){if(t.hasOwnProperty(n)){e[n]=t[n]}}};r.contains=function(e,t){"use strict";var n=e.length;while(n--){if(e[n]===t){return true}}return false};r.removeItem=function(e,t){"use strict";var n=e.length;while(n--){if(e[n]===t){e.splice(n,1);break}}};r.addEvent=function(e,t,n){"use strict";if(e.addEventListener){e.addEventListener(t,n,false)}else{e.attachEvent("on"+t,n)}return function(){r.removeEvent(e,t,n)}};r.removeEvent=function(e,t,n){"use strict";if(e.removeEventListener){e.removeEventListener(t,n,false)}else{e.detachEvent("on"+t,n)}};r.newXHR=function(){"use strict";if(typeof XMLHttpRequest!=="undefined"){return new e.XMLHttpRequest}else if(e.ActiveXObject){try{return new e.ActiveXObject("Microsoft.XMLHTTP")}catch(t){return false}}};r.parseJSON=function(t){"use strict";if(!t){return false}t=r.trim(t);if(e.JSON&&e.JSON.parse){try{return e.JSON.parse(t)}catch(n){return false}}if(t){if(/^[\],:{}\s]*$/.test(t.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){return(new Function("return "+t))()}}return false};r.getBox=function(n){"use strict";var r,i,s=0,o=0;if(n.getBoundingClientRect){r=n.getBoundingClientRect();i=t.documentElement;s=r.top+(e.pageYOffset||i.scrollTop)-(i.clientTop||0);o=r.left+(e.pageXOffset||i.scrollLeft)-(i.clientLeft||0)}else{do{o+=n.offsetLeft;s+=n.offsetTop}while(n=n.offsetParent)}return{top:Math.round(s),left:Math.round(o)}};r.addStyles=function(e,t){"use strict";for(var n in t){if(t.hasOwnProperty(n)){e.style[n]=t[n]}}};r.copyLayout=function(e,t){"use strict";var n=r.getBox(e);r.addStyles(t,{position:"absolute",left:n.left+"px",top:n.top+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px"})};r.toElement=function(){"use strict";var e=t.createElement("div");return function(t){e.innerHTML=t;var n=e.firstChild;e.removeChild(n);return n}}();r.getUID=function(){"use strict";return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(o,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})};r.trim=function(e){"use strict";return e.toString().replace(i,"").replace(s,"")};r.getFilename=function(e){"use strict";return e.replace(u,"")};r.getExt=function(e){"use strict";return-1!==e.indexOf(".")?e.replace(a,""):""};r.hasClass=function(e,t){"use strict";return(" "+e.className+" ").replace(f," ").indexOf(" "+t+" ")>=0};r.addClass=function(e,t){"use strict";if(!t||t===""){return false}if(!r.hasClass(e,t)){e.className+=" "+t}};r.removeClass=function(){"use strict";var e={};return function(t,n){if(!e[n]){e[n]=new RegExp("(?:^|\\s)"+n+"(?!\\S)")}t.className=t.className.replace(e[n],"")}}();r.purge=function(e){"use strict";var t=e.attributes,n,i,s;if(t){for(n=t.length-1;n>=0;n-=1){s=t[n].name;if(typeof e[s]==="function"){e[s]=null}}}t=e.childNodes;if(t){i=t.length;for(n=0;n<i;n+=1){r.purge(e.childNodes[n])}}};r.remove=function(e){"use strict";if(e.parentNode){r.purge(e);e.parentNode.removeChild(e)}e=null};r.verifyElem=function(n){"use strict";if(typeof jQuery!=="undefined"&&n instanceof jQuery){n=n[0]}else if(typeof n==="string"){if(n.charAt(0)=="#"){n=n.substr(1)}n=t.getElementById(n)}if(!n||n.nodeType!==1){return false}if(n.nodeName.toUpperCase()=="A"){n.style.cursor="pointer";r.addEvent(n,"click",function(t){if(t&&t.preventDefault){t.preventDefault()}else if(e.event){e.event.returnValue=false}})}return n};r.SimpleUpload=function(e){"use strict";var t,n,i;this._opts={button:"",url:"",cors:false,progressUrl:false,nginxProgressUrl:false,multiple:false,maxUploads:3,queue:true,checkProgressInterval:50,keyParamName:"APC_UPLOAD_PROGRESS",nginxProgressHeader:"X-Progress-ID",corsInputName:"XHR_CORS_TARGETORIGIN",allowedExtensions:[],accept:"",maxSize:false,name:"",data:{},autoSubmit:true,multipart:false,method:"POST",responseType:"",debug:false,hoverClass:"",focusClass:"",disabledClass:"",onAbort:function(e,t){},onChange:function(e,t,n){},onSubmit:function(e,t,n){},onProgress:function(e){},onUpdateFileSize:function(e){},onComplete:function(e,t,n){},onExtError:function(e,t){},onSizeError:function(e,t){},onError:function(e,t,n,r,i,s){},startXHR:function(e,t,n){},endXHR:function(e,t,n){},startNonXHR:function(e,t){},endNonXHR:function(e,t){}};r.extendObj(this._opts,e);e=null;this._btns=[];if(this._opts.button instanceof Array){n=this._opts.button.length;for(t=0;t<n;t++){i=r.verifyElem(this._opts.button[t]);if(i!==false){this._btns.push(this.rerouteClicks(i))}else{this.log("Button with array index "+t+" is invalid")}}}else{i=r.verifyElem(this._opts.button);if(i!==false){this._btns.push(this.rerouteClicks(i))}}delete this._opts.button;if(this._btns.length<1||this._btns[0]===false){throw new Error("Invalid button. Make sure the element you're passing exists.")}if(this._opts.multiple===false){this._opts.maxUploads=1}this._queue=[];this._active=0;this._disabled=false;this._progKeys=[];this._maxFails=10;if(!h){this._sizeFlags={}}this._createInput();this.enable()};r.SimpleUpload.prototype={destroy:function(){"use strict";var e=this._btns.length;while(e--){if(this._btns[e].off){this._btns[e].off()}r.removeClass(this._btns[e],this._opts.hoverClass);r.removeClass(this._btns[e],this._opts.focusClass);r.removeClass(this._btns[e],this._opts.disabledClass);this._btns[e].disabled=false}r.remove(this._input.parentNode);for(var t in this){if(this.hasOwnProperty(t)){delete this.prop}}},log:function(t){"use strict";if(this._opts.debug&&e.console){console.log("[uploader] "+t)}},setData:function(e){"use strict";this._opts.data=e},setProgressBar:function(e){"use strict";this._progBar=r.verifyElem(e)},setPctBox:function(e){"use strict";this._pctBox=r.verifyElem(e)},setFileSizeBox:function(e){"use strict";this._sizeBox=r.verifyElem(e)},setProgressContainer:function(e){"use strict";this._progBox=r.verifyElem(e)},setAbortBtn:function(e,t){"use strict";this._abortBtn=r.verifyElem(e);this._removeAbort=false;if(t){this._removeAbort=true}},getQueueSize:function(){"use strict";return this._queue.length},_cycleQueue:function(){"use strict";if(this._queue.length>0&&this._opts.autoSubmit){this.submit()}},removeCurrent:function(){"use strict";var e=this._queue.length;while(e--){if(this._queue[e].file===this._file){this._queue.splice(e,1);break}}delete this._file;this._cycleQueue()},disable:function(){"use strict";var e=this._btns.length,t;this._disabled=true;while(e--){t=this._btns[e].nodeName.toUpperCase();r.addClass(this._btns[e],this._opts.disabledClass);if(t=="INPUT"||t=="BUTTON"){this._btns[e].disabled=true}}if(this._input&&this._input.parentNode){this._input.parentNode.style.visibility="hidden"}},enable:function(){"use strict";var e=this._btns.length;this._disabled=false;while(e--){r.removeClass(this._btns[e],this._opts.disabledClass);this._btns[e].disabled=false}},_getHost:function(e){var n=t.createElement("a");n.href=e;if(n.hostname){return n.hostname.toLowerCase()}return e},_createInput:function(){"use strict";var e=this,n=t.createElement("div");this._input=t.createElement("input");this._input.type="file";this._input.name=this._opts.name;if(h&&!l){this._input.multiple=true}if("accept"in this._input&&this._opts.accept!==""){this._input.accept=this._opts.accept}r.addStyles(n,{display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483583});r.addStyles(this._input,{position:"absolute",right:0,margin:0,padding:0,fontSize:"480px",fontFamily:"sans-serif",cursor:"pointer"});if(n.style.opacity!=="0"){n.style.filter="alpha(opacity=0)"}r.addEvent(this._input,"change",function(){var t=e._overBtn,n,i,s,o;if(!e._input||e._input.value===""){return}if(!h){n=r.getFilename(e._input.value);i=r.getExt(n);if(false===e._opts.onChange.call(e,n,i,t)){return}e._queue.push({file:e._input,btn:t})}else{n=r.getFilename(e._input.files[0].name);i=r.getExt(n);if(false===e._opts.onChange.call(e,n,i,t)){return}s=e._input.files.length;if(!e._opts.multiple){s=1}for(o=0;o<s;o++){e._queue.push({file:e._input.files[o],btn:t})}}r.removeClass(e._overBtn,e._opts.hoverClass);r.removeClass(e._overBtn,e._opts.focusClass);r.remove(e._input.parentNode);delete e._input;e._createInput();if(e._opts.autoSubmit){e.submit()}});r.addEvent(this._input,"mouseover",function(){r.addClass(e._overBtn,e._opts.hoverClass)});r.addEvent(this._input,"mouseout",function(){r.removeClass(e._overBtn,e._opts.hoverClass);r.removeClass(e._overBtn,e._opts.focusClass);e._input.parentNode.style.visibility="hidden"});r.addEvent(this._input,"focus",function(){r.addClass(e._overBtn,e._opts.focusClass)});r.addEvent(this._input,"blur",function(){r.removeClass(e._overBtn,e._opts.focusClass)});t.body.appendChild(n);n.appendChild(this._input)},rerouteClicks:function(e){"use strict";var t=this;e.off=r.addEvent(e,"mouseover",function(){if(t._disabled){return}if(!t._input){t._createInput()}t._overBtn=e;r.copyLayout(e,t._input.parentNode);t._input.parentNode.style.visibility="visible"});return e},_getFrame:function(){"use strict";var e=r.getUID(),n=r.toElement('<iframe src="javascript:false;" name="'+e+'" />');t.body.appendChild(n);n.style.display="none";n.id=e;return n},_getForm:function(e,n){"use strict";var i=r.toElement('<form method="post" enctype="multipart/form-data"></form>'),s=this._opts.url;t.body.appendChild(i);i.style.display="none";if(this._opts.nginxProgressUrl){s=s+(s.indexOf("?")>-1?"&":"?")+encodeURIComponent(this._opts.nginxProgressHeader)+"="+encodeURIComponent(n)}i.action=s;i.target=e.name;return i},_getHidden:function(e,n){"use strict";var r=t.createElement("input");r.type="hidden";r.name=e;r.value=n;return r},_last:function(e,t,n,i,s){"use strict";if(e){e.innerHTML=""}if(t){r.remove(t)}if(n){n.innerHTML=""}if(i&&s){r.remove(i)}this._active--;e=t=n=i=s=null;if(this._disabled){this.enable()}this._cycleQueue()},_errorFinish:function(e,t,n,i,s,o,u,a,f,l,c){"use strict";this.log("Upload failed: "+e+" "+t);n=r.parseJSON(n);this._opts.onError.call(this,s,i,e,t,n,c);this._last(o,u,a,f,l);e=t=n=i=s=o=u=a=f=l=c=null},_finish:function(e,t,n,i,s,o,u,a,f,l){"use strict";this.log("Server response: "+n);if(this._opts.responseType.toLowerCase()=="json"){n=r.parseJSON(n);if(n===false){this._errorFinish(e,t,false,"parseerror",i,s,o,a,f,l);return}}this._opts.onComplete.call(this,i,n,l);this._last(s,o,u,a,f);e=t=n=i=s=o=u=a=f=l=null},_uploadXhr:function(e,t,i,s,o,u,a,f,l){"use strict";var c=this,h=this._opts,p=r.newXHR(),d={},v,m,g;d[h.name]=e;r.extendObj(d,h.data);v=h.url+(h.url.indexOf("?")>-1?"&":"?")+r.obj2string(d);if(i){i.innerHTML=t+"K"}if(u){u.innerHTML="0%"}if(s){s.style.width="0%"}h.onProgress.call(this,0);m=function(r,s){var d,v;try{if(m&&(s||p.readyState===4)){m=n;p.onreadystatechange=function(){};if(s){if(p.readyState!==4){p.abort()}c._last(i,o,u,a,f);h.onAbort.call(c,e,l)}else{d=p.status;try{v=p.statusText}catch(g){v=""}if(d>=200&&d<300){h.endXHR.call(c,e,t,l);c._finish(d,v,p.responseText,e,i,o,u,a,f,l)}else{c._errorFinish(d,v,p.responseText,"error",e,i,o,u,a,f,l)}}}}catch(g){if(!s){c._errorFinish(-1,g.message,false,"error",e,i,o,u,a,f,l)}}};g=function(){r.removeEvent(a,"click",g);if(m){m(n,true)}};if(a){r.addEvent(a,"click",g)}p.onreadystatechange=m;p.open(h.method.toUpperCase(),v,true);r.addEvent(p.upload,"progress",function(e){if(e.lengthComputable){var t=Math.round(e.loaded/e.total*100);h.onProgress.call(c,t);if(u){u.innerHTML=t+"%"}if(s){s.style.width=t+"%"}}});var y=$("meta[name='csrf-token']").attr("content");if(y){p.setRequestHeader("X-CSRF-Token",y)}p.setRequestHeader("X-Requested-With","XMLHttpRequest");p.setRequestHeader("X-File-Name",encodeURIComponent(e));if(h.responseType.toLowerCase()=="json"){p.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01")}if(h.multipart===true){var b=new FormData;for(var w in h.data){if(h.data.hasOwnProperty(w)){b.append(w,h.data[w])}}b.append(h.name,this._file);this.log("Commencing upload using multipart form");p.send(b)}else{p.setRequestHeader("Content-Type","application/octet-stream");this.log("Commencing upload using binary stream");p.send(this._file)}this.removeCurrent()},_uploadIframe:function(t,i,s,o,u,a){"use strict";var f=this,l=this._opts,c=l.url,h=r.getUID(),p=this._getFrame(),d=this._getForm(p,h),v=false,m,g;if(l.progressUrl){d.appendChild(this._getHidden(l.keyParamName,h))}for(var y in l.data){if(l.data.hasOwnProperty(y)){d.appendChild(this._getHidden(y,l.data[y]))}}if(l.cors){d.appendChild(this._getHidden(l.corsInputName,e.location.href))}d.appendChild(this._file);l.onProgress.call(this,0);if(u){u.innerHTML="0%"}if(s){s.style.width="0%"}if(l.cors){m=r.addEvent(e,"message",function(e){if(f._getHost(e.origin)!=f._getHost(l.url)){f.log("Non-matching origin: "+e.origin);return}v=true;m();l.endNonXHR.call(f,t,a);f._finish("","",e.data,t,i,o,u,n,n,a)})}g=r.addEvent(p,"load",function(){if(!p.parentNode){return}g();r.removeItem(f._progKeys,h);if(f._sizeFlags[h]){delete f._sizeFlags.key}if(l.cors){e.setTimeout(function(){r.remove(p);if(!v){f._errorFinish("","",false,"error",t,i,o,u,n,n,a)}l=h=p=i=o=u=a=null},600)}else{try{var s=p.contentDocument?p.contentDocument:p.contentWindow.document,c=s.body.innerHTML;l.endNonXHR.call(f,t,a);f._finish("","",c,t,i,o,u,n,n,a)}catch(d){f._errorFinish("",d.message,false,"error",t,i,o,u,n,n,a)}r.remove(p);l=h=p=i=o=u=a=null}});f.log("Commencing upload using iframe");d.submit();r.remove(d);d=null;if(l.progressUrl||l.nginxProgressUrl){this._progKeys.push(h);e.setTimeout(function(){f._getProg(h,s,i,u,1);s=i=u=null},l.checkProgressInterval)}this.removeCurrent()},_getProg:function(t,i,s,o,u){"use strict";var a=this,f=this._opts,l=(new Date).getTime(),c,h,p;if(!t){return}if(f.nginxProgressUrl){h=f.nginxProgressUrl+"?"+encodeURIComponent(f.nginxProgressHeader)+"="+encodeURIComponent(t)+"&_="+l}else if(f.progressUrl){h=f.progressUrl+"?progresskey="+encodeURIComponent(t)+"&_="+l}p=function(){var l,h,d,v,m;try{if(p&&(f.cors||c.readyState===4)){p=n;c.onreadystatechange=function(){};try{m=c.statusText;v=c.status}catch(g){m="";v=""}if(f.cors||v>=200&&v<300){l=r.parseJSON(c.responseText);u++;if(l===false){a.log("Error parsing progress response (expecting JSON)");return}if(f.nginxProgressUrl){if(l.state=="uploading"){h=l.size;if(h>0){d=Math.round(l.received/h*100);h=Math.round(h/1024)}}else if(l.state=="done"){d=100}else if(l.state=="error"){a.log("Error requesting upload progress: "+l.status);return}}else if(f.progressUrl){if(l.success===true){h=l.size;d=l.pct}}if(d){if(o){o.innerHTML=d+"%"}if(i){i.style.width=d+"%"}f.onProgress.call(a,d)}if(h&&!a._sizeFlags[t]){a._sizeFlags[t]=1;if(s){s.innerHTML=h+"K"}f.onUpdateFileSize.call(a,h)}if(!d&&!h&&u>=a._maxFails){a.log("Failed progress request limit reached");return}if(d<100&&r.contains(a._progKeys,t)){e.setTimeout(function(){a._getProg(t,i,s,o,u);t=i=s=o=u=null},f.checkProgressInterval)}}else{r.removeItem(a._progKeys,t);a.log("Error requesting upload progress: "+v+" "+m)}c=h=d=v=m=l=null}}catch(g){a.log("Error requesting upload progress: "+g.message)}};if(f.cors){if(typeof XDomainRequest!=="undefined"){c=new e.XDomainRequest;c.open("GET",h,true);c.onprogress=c.ontimeout=function(){};c.onload=p;c.onerror=function(){r.removeItem(a._progKeys,t);t=null;a.log("Error requesting upload progress")}}else{return}}else{c=r.newXHR();c.onreadystatechange=p;c.open("GET",h,true);if(f.nginxProgressUrl){c.setRequestHeader(f.nginxProgressHeader,t)}var d=$("meta[name='csrf-token']").attr("content");if(d){c.setRequestHeader("X-CSRF-Token",d)}c.setRequestHeader("X-Requested-With","XMLHttpRequest");c.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01")}c.send()},_checkFile:function(e,t,n){"use strict";var r=this._opts.allowedExtensions,i=r.length,s=false;if(i>0){t=t.toLowerCase();while(i--){if(r[i].toLowerCase()==t){s=true;break}}if(!s){this.removeCurrent();this.log("File extension not permitted");this._opts.onExtError.call(this,e,t);return false}}if(n&&this._opts.maxSize!==false&&n>this._opts.maxSize){this.removeCurrent();this.log(e+" exceeds "+this._opts.maxSize+"K limit");this._opts.onSizeError.call(this,e,n);return false}return true},submit:function(){"use strict";var e,t,n;if(this._disabled||this._active>=this._opts.maxUploads||this._queue.length<1){return}this._file=this._queue[0].file;if(h){e=r.getFilename(this._file.name);n=Math.round(this._file.size/1024)}else{e=r.getFilename(this._file.value)}t=r.getExt(e);if(!this._checkFile(e,t,n)){return}if(false===this._opts.onSubmit.call(this,e,t,this._queue[0].btn)){return}this._active++;if(this._opts.multiple===false||this._opts.queue===false&&this._active>=this._opts.maxUploads){this.disable()}if(h){if(false===this._opts.startXHR.call(this,e,n,this._queue[0].btn)){if(this._disabled){this.enable()}this._active--;return}this._uploadXhr(e,n,this._sizeBox,this._progBar,this._progBox,this._pctBox,this._abortBtn,this._removeAbort,this._queue[0].btn)}else{if(false===this._opts.startNonXHR.call(this,e,this._queue[0].btn)){if(this._disabled){this.enable()}this._active--;return}this._uploadIframe(e,this._sizeBox,this._progBar,this._progBox,this._pctBox,this._queue[0].btn)}this._sizeBox=this._progBar=this._progBox=this._pctBox=this._abortBtn=this._removeAbort=null}};e.ss=r})(window,document)
